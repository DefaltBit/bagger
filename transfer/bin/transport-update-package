#!/usr/bin/env perl

use strict;
use warnings;
use Cwd;
use DBI;

$/ = undef;

my ($id, $status) = @ARGV;
@ARGV = ();
my $root = cwd();

my $dbh = DBI->connect("dbi:Pg:dbname=transfer", "", "");
die "Cannot connect to database: $!" unless $dbh;

my $stmt;

if ($status eq "started") {
    $stmt = $dbh->prepare(<<"    EOSQL");
        UPDATE transport.tickets
        SET status=?, initiated_timestamp=NOW(), updated_timestamp=NOW()
        WHERE ticket_id = ?
    EOSQL
} elsif ($status eq "completed") {
    $stmt = $dbh->prepare(<<"    EOSQL");
        UPDATE transport.tickets
        SET status=?, completed_timestamp=NOW(), updated_timestamp=NOW()
        WHERE ticket_id = ?
    EOSQL
} else {
    $stmt = $dbh->prepare(<<"    EOSQL");
        UPDATE transport.tickets
        SET status=?, updated_timestamp=NOW()
        WHERE ticket_id = ?
    EOSQL
}

$stmt->execute($status, $id) or die("Cannot update for ticket $id.\n");
