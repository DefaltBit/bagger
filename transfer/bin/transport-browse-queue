#!/usr/bin/env perl

use strict;
use warnings;
use DBI;

##-----------------------------------------------------------------

my $dbh = DBI->connect("dbi:Pg:dbname=transfer", "", "");
die "Error: connect to database: $!" unless $dbh;

sub status {
    my $tickets = $dbh->selectall_arrayref(<<"    EOSQL");
        SELECT ticket_id, package_name, repository, estimated_size
        FROM transport.tickets
        WHERE status = 'queued'
        ORDER BY created_timestamp;
    EOSQL

    my $stmt = $dbh->prepare(<<"    EOSQL");
        SELECT role, file_owner, hostname, root_directory
        FROM transport.locations
        WHERE ticket_id = ?
        ORDER BY location_id;
    EOSQL

    foreach (@$tickets) {
        my ($id, $package, $repo, $size) = @$_;
        $stmt->execute($id);
        my $locations = $stmt->fetchall_arrayref();

        print <<EOF;
Ticket: $id
Package: $package
Repository: $repo
Estimated-Size: $size
EOF
        foreach (@$locations) {
            my ($role, $owner, $hostname, $dir) = @$_;

            ## Ignore owners for workspace copies
            $owner = undef if $role eq "workspace";

            my $descriptor = "$hostname:$dir";
            $descriptor = "$owner\@$descriptor" if $owner;
            print <<EOF;
\u$role: $descriptor
EOF
        }
        print "\n"
    }    
}

status();
