<?xml version="1.0" encoding="UTF-8"?>
<beans xmlns="http://www.springframework.org/schema/beans" 
    xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
    xmlns:p="http://www.springframework.org/schema/p" 	
    xmlns:aop="http://www.springframework.org/schema/aop"
    xmlns:tx="http://www.springframework.org/schema/tx"
    xmlns:context="http://www.springframework.org/schema/context"
    xsi:schemaLocation="
        http://www.springframework.org/schema/beans 
        http://www.springframework.org/schema/beans/spring-beans-2.5.xsd
        http://www.springframework.org/schema/context 
        http://www.springframework.org/schema/context/spring-context-2.5.xsd">
  	<import resource="classpath:conf/security-context.xml" />
	<import resource="classpath:conf/packagemodeler-core-context.xml" />
	<import resource="classpath:conf/workflow-continuations-context.xml" />
	<import resource="classpath:conf/servicerequestbroker-context.xml" />
  
    <context:annotation-config />
    <context:component-scan base-package="gov.loc.repository.transfer.ui" />
  
	<bean id="customEditorConfigurer" class="org.springframework.beans.factory.config.CustomEditorConfigurer">
  		<property name="customEditors">
    		<map>
      			<entry key="java.util.Properties" value="gov.loc.repository.springframework.PropertiesEditor" />
    		</map>
 		</property>
	</bean>
  
	
    <bean id="messageSource" class="gov.loc.repository.transfer.ui.springframework.ResourceBundleMessageSource">
    </bean>

	<!-- Following best practices, this should be used for (part) of url mapping -->
	<bean id="abstractHandlerMapping" abstract="true" >
		<property name="interceptors">
			<list>
				<ref bean="contextPathInterceptor" />
				<ref bean="messageInterceptor" />
				<ref bean="referrerInterceptor" />
			</list>
		</property>	
	</bean> 
	
	<bean id="urlHandler3" parent="abstractHandlerMapping" class="org.springframework.web.servlet.handler.SimpleUrlHandlerMapping">
        <property name="mappings">
            <value>
                /reports/index.html=reportsController
                /admin/index.html=adminController
                /admin/completedrequestlistener.html=completedServiceRequestListenerController
                /admin/servicerequestbroker.html=serviceRequestBrokerController
                /admin/servicecontainer.html=serviceContainerController
                /login/*=loginController
                /processinstance/*/comment.*=commentController
                /processinstance/*.*=processInstanceController
                /processdefinition/*.*=processDefinitionController
                /token/*.*=tokenController
                /**=homeController
            </value>
        </property>
		<property name="interceptors">
			<list merge="true">
				<ref bean="jbpmContextInterceptor" />
			</list>
		</property>
		<property name="order" value="3" />		                    
    </bean>

	<bean id="urlHandler2" parent="abstractHandlerMapping" class="org.springframework.web.servlet.handler.SimpleUrlHandlerMapping">
        <property name="mappings">
            <value>
                /taskinstance/*.*=taskInstanceController
            </value>
        </property>
		<property name="interceptors">
			<list merge="true">
				<ref bean="packageModelerInterceptor" />
				<ref bean="jbpmContextInterceptor" />
			</list>
		</property>
		<property name="order" value="2" />		                    
    </bean>

	<bean id="urlHandler1" parent="abstractHandlerMapping" class="gov.loc.repository.transfer.ui.springframework.ControllerClassNameHandlerMapping">
		<property name="pathPrefix" value="/reports" />
		<property name="controllerMarker" value="gov.loc.repository.transfer.ui.controllers.reports.Report" />
		<property name="order" value="1" />
		<property name="interceptors">
			<list merge="true">
				<ref bean="packageModelerInterceptor" />
				<ref bean="jbpmContextInterceptor" />				
				<bean class="gov.loc.repository.transfer.ui.interceptors.ViewInterceptor">
					<property name="view" value="report" />
				</bean>
			</list>
		</property>		
	</bean>
    
    <bean id="contextPathInterceptor" class="gov.loc.repository.transfer.ui.interceptors.ContextPathInterceptor" />
    
    <bean id="messageInterceptor" class="gov.loc.repository.transfer.ui.interceptors.MessageInterceptor" />
    
    <bean id="referrerInterceptor" class="gov.loc.repository.transfer.ui.interceptors.ReferrerInterceptor" />
    
    <bean id="jbpmContextInterceptor" class="gov.loc.repository.transfer.ui.interceptors.JbpmContextInterceptor" />

	<bean id="packageModelerInterceptor" class="org.springframework.orm.hibernate3.support.OpenSessionInViewInterceptor">
		<property name="sessionFactory" ref="packageModelerSessionFactory" />
	</bean>
    
    <bean id="tilesConfigurer" class="gov.loc.repository.transfer.ui.springframework.TilesConfigurer">
	    <property name="factoryClass" value="org.apache.struts.tiles.xmlDefinition.I18nFactorySet"/>
		<property name="definitionPath" value="/WEB-INF/views/" />
		<property name="definitionPattern" value="pages-*.xml" />
    </bean>

	<bean id="multipartResolver" class="org.springframework.web.multipart.commons.CommonsMultipartResolver">
		<property name="maxUploadSize" value="1000000"/>
	</bean>
	
	<bean id="velocityConfig" 
    class="org.springframework.web.servlet.view.velocity.VelocityConfigurer">
		<property name="resourceLoaderPath" value="/WEB-INF/views/templates,/WEB-INF/views/reports"/>
		<property name="velocityProperties"> <props>
				<prop key="input.encoding"                      >UTF-8</prop>
				<prop key="output.encoding"                     >UTF-8</prop>
				<prop key="runtime.log.logsystem.class"         >org.apache.velocity.runtime.log.SimpleLog4JLogSystem</prop>
				<prop key="runtime.log.logsystem.log4j.category">org.apache.velocity.runtime.log.SimpleLog4JLogSystem</prop>
				<prop key="runtime.log.error.stacktrace"        >false</prop>
				<prop key="runtime.log.warn.stacktrace"         >false</prop>
				<prop key="runtime.log.info.stacktrace"         >false</prop>
				<prop key="runtime.log.invalid.reference"       >true</prop>
		        <prop key="velocimacro.library"                 >macros-functions.vm</prop>
				<prop key="velocimacro.permissions.allow.inline">true</prop>
				<prop key="velocimacro.permissions.allow.inline.to.replace.global">false</prop>
				<prop key="velocimacro.permissions.allow.inline.local.scope">false</prop>
				<prop key="velocimacro.context.localscope"      >false</prop>
				<prop key="velocimacro.library.autoreload"      >true</prop>
				<prop key="file.resource.loader.cache"          >false</prop>
				<prop key="directive.foreach.counter.name"      >velocityCount</prop>
				<prop key="directive.foreach.counter.initial.value">1</prop>
		</props> </property>
	</bean>	

  <bean id="viewResolver" class="org.springframework.web.servlet.view.velocity.VelocityViewResolver">
  	<property name="cache"                    value="true" />
  	<property name="prefix"                   value="" />
  	<property name="exposeSpringMacroHelpers" value="true" />
  	<property name="order"                    value="1"/>
  	<property name="contentType"              value="text/html; charset=utf-8"/>
  	<property name="toolboxConfigLocation"    value="WEB-INF/velocity-toolbox.xml"/>
    <property name="suffix"                   value="" />
    <property name="viewClass"                value="gov.loc.repository.transfer.ui.springframework.VelocityTilesView" />
  </bean>
  
</beans>
